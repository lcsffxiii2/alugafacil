<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AlugaFácil - Controle Compartilhado</title>
  <link href="/bootstrap.min.css" rel="stylesheet">
  <!--<link href="https://cdn.jsdeflivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/pocketbase@0.22.1/dist/pocketbase.umd.js"></script>

  <style>
    body { background: #f8f9fa; font-family: system-ui, sans-serif; }
    .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
    .nav-link { color: #bdc3c7 !important; }
    .nav-link.active, .nav-link:hover { background: #34495e; color: white !important; }
    .login-container { max-width: 420px; margin: 100px auto; padding: 2.5rem; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
    .hidden { display: none !important; }
    .card-imovel:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.12); transition: all 0.25s; }
  </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="loginScreen">
  <div class="login-container">
    <h3 class="text-center mb-4 text-primary"><i class="fas fa-home me-2"></i> AlugaFácil</h3>
    <p class="text-center text-muted mb-4">Controle compartilhado de imóveis e aluguéis</p>

    <form id="formLogin">
      <div class="mb-3">
        <label class="form-label">Usuário</label>
        <input type="text" class="form-control" id="loginUsername" required autofocus placeholder="usuário">
      </div>
      <div class="mb-3">
        <label class="form-label">Senha</label>
        <input type="password" class="form-control" id="loginPassword" required placeholder="senha">
      </div>
      <button type="submit" class="btn btn-primary w-100 py-2">Entrar</button>
    </form>

    <div id="loginAlert" class="alert mt-4" role="alert" style="display:none;"></div>
  </div>
</div>

<!-- APLICAÇÃO PRINCIPAL -->
<div id="mainApp" class="d-flex hidden">
  <!-- Sidebar -->
  <div class="sidebar p-3" style="width:260px;">
    <h4 class="text-center mb-4"><i class="fas fa-home"></i> AlugaFácil</h4>
    <small class="d-block text-center mb-3">Usuário: <strong id="currentUserDisplay"></strong></small>

    <ul class="nav flex-column">
      <li class="nav-item"><a href="#" class="nav-link active" onclick="showTab(0)"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showTab(1)"><i class="fas fa-building me-2"></i> Imóveis</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showTab(2)"><i class="fas fa-users me-2"></i> Inquilinos</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showTab(3)"><i class="fas fa-file-contract me-2"></i> Contratos</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showTab(4)"><i class="fas fa-money-bill-wave me-2"></i> Financeiro</a></li>
      <li class="nav-item mt-5"><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Sair</a></li>
    </ul>
  </div>

  <!-- Conteúdo principal -->
  <div class="flex-grow-1 p-4">

    <!-- Dashboard -->
    <div id="tab0" class="tab-content">
      <h2 class="mb-4">Dashboard</h2>
      <div class="row g-4">
        <div class="col-md-3">
          <div class="card text-white bg-primary h-100">
            <div class="card-body">
              <h5>Total Imóveis</h5>
              <h2 id="totalImoveis">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success h-100">
            <div class="card-body">
              <h5>Alugados</h5>
              <h2 id="imoveisAlugados">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning h-100">
            <div class="card-body">
              <h5>Renda Mensal</h5>
              <h2 id="rendaMensal">R$ 0,00</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-danger h-100">
            <div class="card-body">
              <h5>Atrasados</h5>
              <h2 id="contratosAtrasados">0</h2>
              <small id="totalAtrasado">R$ 0,00</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Imóveis -->
    <div id="tab1" class="tab-content d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Imóveis</h2>
        <button class="btn btn-success" onclick="abrirModalImovel()">
          <i class="fas fa-plus"></i> Novo imóvel
        </button>
      </div>
      <div class="row" id="listaImoveis"></div>
    </div>

    <!-- Inquilinos -->
    <div id="tab2" class="tab-content d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Inquilinos</h2>
        <button class="btn btn-success" onclick="abrirModalInquilino()">
          <i class="fas fa-plus"></i> Novo inquilino
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="tabelaInquilinos">
          <thead class="table-dark">
            <tr>
              <th>Nome</th>
              <th>CPF</th>
              <th>Data Nasc.</th>
              <th>Estado Civil</th>
              <th>Profissão</th>
              <th>Nacionalidade</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Contratos -->
    <div id="tab3" class="tab-content d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Contratos</h2>
        <div>
          <label class="form-label me-2">Filtrar Status:</label>
          <select class="form-select d-inline-block w-auto" id="filtroStatusContrato" onchange="renderContratos()">
            <option value="todos">Todos</option>
            <option value="ativos">Ativos</option>
            <option value="encerrados">Encerrados</option>
          </select>
          <button class="btn btn-success ms-3" onclick="abrirModalContrato()">
            <i class="fas fa-plus"></i> Novo Contrato
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="tabelaContratos">
          <thead class="table-dark">
            <tr>
              <th>Imóvel</th>
              <th>Inquilino</th>
              <th>Início</th>
              <th>Fim</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Financeiro -->
    <div id="tab4" class="tab-content d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Financeiro</h2>
        <button class="btn btn-success" onclick="abrirModalPagamento()">
          <i class="fas fa-plus"></i> Registrar Pagamento
        </button>
      </div>
      <div class="mb-3">
        <label class="form-label">Filtrar por Mês/Ano</label>
        <input type="month" class="form-control" id="filtroFinanceiro" onchange="renderFinanceiro()">
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="tabelaFinanceiro">
          <thead class="table-dark">
            <tr>
              <th>Imóvel</th>
              <th>Mês/Ano</th>
              <th>Valor Devido</th>
              <th>Valor Pago</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Imóvel -->
<div class="modal fade" id="modalImovel" tabindex="-1" aria-labelledby="modalImovelTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalImovelTitle">Novo Imóvel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Endereço completo</label>
          <input type="text" class="form-control" id="imovelEndereco" required>
        </div>
        <div class="row">
          <div class="col-6">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="imovelTipo" required>
              <option value="Casa">Casa</option>
              <option value="Kitnet">Kitnet</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Valor do aluguel (R$)</label>
            <input type="number" step="0.01" class="form-control" id="imovelValor" required>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarImovel()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Inquilino -->
<div class="modal fade" id="modalInquilino" tabindex="-1" aria-labelledby="modalInquilinoTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalInquilinoTitle">Novo Inquilino</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Nome completo</label>
            <input type="text" class="form-control" id="inquilinoNome" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Data de nascimento</label>
            <input type="date" class="form-control" id="inquilinoNasc" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">CPF</label>
            <input type="text" class="form-control" id="inquilinoCpf" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">RG (opcional)</label>
            <input type="text" class="form-control" id="inquilinoRg">
          </div>
          <div class="col-md-4">
            <label class="form-label">Estado Civil</label>
            <select class="form-select" id="inquilinoCivil">
              <option value="Solteiro(a)">Solteiro(a)</option>
              <option value="Casado(a)">Casado(a)</option>
              <option value="Divorciado(a)">Divorciado(a)</option>
              <option value="Viúvo(a)">Viúvo(a)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Profissão (opcional)</label>
            <input type="text" class="form-control" id="inquilinoProfissao">
          </div>
          <div class="col-md-4">
            <label class="form-label">Nacionalidade</label>
            <input type="text" class="form-control" id="inquilinoNac" value="Brasileira">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarInquilino()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Contrato -->
<div class="modal fade" id="modalContrato" tabindex="-1" aria-labelledby="modalContratoTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalContratoTitle">Novo Contrato</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3"><label>Imóvel</label><select class="form-select" id="contratoImovel" required></select></div>
        <div class="mb-3"><label>Inquilino</label><select class="form-select" id="contratoInquilino" required></select></div>
        <div class="row">
          <div class="col-6"><label>Início</label><input type="date" class="form-control" id="contratoInicio" required></div>
          <div class="col-6"><label>Fim</label><input type="date" class="form-control" id="contratoFim" required></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="salvarContrato()">Cadastrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPagamentoTitle">Registrar/Editar Pagamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pagId">
        <div class="mb-3"><label>Imóvel</label><select class="form-select" id="pagImovel" required></select></div>
        <div class="mb-3"><label>Mês/Ano</label><input type="month" class="form-control" id="pagMesAno" required></div>
        <div class="mb-3"><label>Valor pago (R$)</label><input type="number" step="0.01" class="form-control" id="pagValor" required></div>
        <div class="mb-3"><label>Data pagamento</label><input type="date" class="form-control" id="pagData"></div>
        <div class="mb-3"><label>Observações</label><textarea class="form-control" id="pagObs" rows="3"></textarea></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="salvarPagamento()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const pb = new PocketBase('https://alugafacil.fly.dev');  // ← URL DO BACKEND NO FLY.IO

let currentUser = null;
let imoveis = [];
let inquilinos = [];
let contratos = [];
let pagamentos = [];

// Verifica se já está logado ao carregar a página
async function checkAuth() {
  if (pb.authStore.isValid) {
    currentUser = pb.authStore.model;
    document.getElementById('currentUserDisplay').textContent = currentUser.username || currentUser.email || 'Usuário';
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    showTab(0);
    await loadAllData();
  } else {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }
}

document.getElementById('formLogin').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const alertEl = document.getElementById('loginAlert');

  try {
    await pb.collection('users').authWithPassword(username, password);
    currentUser = pb.authStore.model;
    document.getElementById('currentUserDisplay').textContent = currentUser.username;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    showTab(0);
    await loadAllData();
  } catch (err) {
    alertEl.textContent = 'Login falhou: ' + (err.message || 'Usuário ou senha incorretos');
    alertEl.className = 'alert alert-danger';
    alertEl.style.display = 'block';
  }
});

function logout() {
  pb.authStore.clear();
  currentUser = null;
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('formLogin').reset();
  document.getElementById('loginAlert').style.display = 'none';
}

// Chama verificação de auth ao carregar a página
window.addEventListener('load', checkAuth);

async function loadAllData() {
  try {
    const imRes = await pb.collection('imoveis').getList(1, 200, { expand: 'inquilinoId' });
    imoveis = imRes.items;

    const inqRes = await pb.collection('inquilinos').getList(1, 200);
    inquilinos = inqRes.items;

    const conRes = await pb.collection('contratos').getList(1, 200, { expand: 'imovelId,inquilinoId' });
    contratos = conRes.items;

    const pagRes = await pb.collection('pagamentos').getList(1, 500, { expand: 'imovelId' });
    pagamentos = pagRes.items;

    renderImoveis();
    renderInquilinos();
    renderContratos();
    renderFinanceiro();
    atualizarDashboard();
  } catch (err) {
    console.error('Erro ao carregar dados:', err);
    alert('Não foi possível carregar os dados. Verifique se o PocketBase está rodando.');
  }
}

function showTab(n) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
  document.getElementById('tab' + n).classList.remove('d-none');

  if (n === 0) atualizarDashboard();
  if (n === 3) renderContratos();
  if (n === 4) renderFinanceiro();
}

function atualizarDashboard() {
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  };

  const total = imoveis.length;
  const alugados = imoveis.filter(i => i.inquilinoId).length;
  const renda = imoveis.filter(i => i.inquilinoId).reduce((s, i) => s + Number(i.valor || 0), 0);

  let atrasados = 0;
  let valorAtraso = 0;

  imoveis.filter(i => i.inquilinoId).forEach(im => {
    const vencido = pagamentos.filter(p => p.imovelId === im.id && Number(p.valorPago || 0) < Number(im.valor || 0));
    if (vencido.length > 0) {
      atrasados += vencido.length;
      valorAtraso += vencido.reduce((s, p) => s + (Number(im.valor || 0) - Number(p.valorPago || 0)), 0);
    }
  });

  set('totalImoveis', total);
  set('imoveisAlugados', alugados);
  set('rendaMensal', 'R$ ' + renda.toLocaleString('pt-BR'));
  set('contratosAtrasados', atrasados);
  set('totalAtrasado', 'R$ ' + valorAtraso.toLocaleString('pt-BR', { minimumFractionDigits: 2 }));
}

function renderImoveis() {
  const container = document.getElementById('listaImoveis');
  if (!container) return;
  container.innerHTML = '';
  imoveis.forEach(im => {
    const iq = im.expand?.inquilinoId || {};
    const div = document.createElement('div');
    div.className = 'col-md-4 mb-3';
    div.innerHTML = `<div class="card">
      <div class="card-body">
        <h5>${im.endereco || 'Sem endereço'}</h5>
        <p>${im.tipo} - R$ ${Number(im.valor || 0).toLocaleString('pt-BR')}</p>
        <p><small>${im.inquilinoId ? 'Alugado para ' + (iq.nome || '?') : 'Disponível'}</small></p>
      </div>
    </div>`;
    container.appendChild(div);
  });
}

function renderInquilinos() {
  const tbody = document.querySelector('#tabelaInquilinos tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  inquilinos.forEach(iq => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${iq.nome || '-'}</td>
      <td>${iq.cpf || '-'}</td>
      <td>${iq.nasc ? new Date(iq.nasc).toLocaleDateString('pt-BR') : '-'}</td>
      <td>${iq.civil || '-'}</td>
      <td>${iq.profissao || '-'}</td>
      <td>${iq.nacionalidade || '-'}</td>`;
    tbody.appendChild(tr);
  });
}

function renderContratos() {
  const tbody = document.querySelector('#tabelaContratos tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const filtro = document.getElementById('filtroStatusContrato')?.value || 'todos';

  const contratosFiltrados = contratos.filter(con => {
    const ativo = con.ativo !== false; // true ou undefined = ativo
    if (filtro === 'ativos') return ativo;
    if (filtro === 'encerrados') return !ativo;
    return true; // 'todos'
  });

  contratosFiltrados.forEach(con => {
    const im = con.expand?.imovelId || {};
    const iq = con.expand?.inquilinoId || {};
    const inicio = im.dataInicio ? new Date(im.dataInicio).toLocaleDateString('pt-BR') : '-';
    const fim = im.dataFim ? new Date(im.dataFim).toLocaleDateString('pt-BR') : '-';
    const status = con.ativo !== false ? 'Ativo' : 'Encerrado';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${im.endereco || '-'}</td>
      <td>${iq.nome || '-'}</td>
      <td>${inicio}</td>
      <td>${fim}</td>
      <td><span class="badge ${status === 'Ativo' ? 'bg-success' : 'bg-secondary'}">${status}</span></td>
      <td>${status === 'Ativo' ? `<button class="btn btn-sm btn-danger" onclick="encerrarContrato('${con.id}', '${im.id}')">Encerrar</button>` : ''}</td>`;
    tbody.appendChild(tr);
  });
}

function renderFinanceiro() {
  const tbody = document.querySelector('#tabelaFinanceiro tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const filtroMesAno = document.getElementById('filtroFinanceiro')?.value || '';

  const pagamentosFiltrados = filtroMesAno 
    ? pagamentos.filter(pag => pag.mesAno === filtroMesAno)
    : pagamentos;

  pagamentosFiltrados.forEach(pag => {
    const im = pag.expand?.imovelId || {};
    const mesAno = pag.mesAno || '-';
    const valorDevido = Number(im.valor || 0);
    const valorPago = Number(pag.valorPago || 0);
    const status = valorPago >= valorDevido ? 'Pago' : (valorPago > 0 ? 'Parcial' : 'Pendente');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${im.endereco || '-'}</td>
      <td>${mesAno}</td>
      <td>R$ ${valorDevido.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
      <td>R$ ${valorPago.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
      <td><span class="badge ${status === 'Pago' ? 'bg-success' : status === 'Parcial' ? 'bg-warning' : 'bg-danger'}">${status}</span></td>
      <td><button class="btn btn-sm btn-primary" onclick="editarPagamento('${pag.id}')">Editar</button></td>`;
    tbody.appendChild(tr);
  });
}

function abrirModalImovel() {
  document.getElementById('imovelEndereco').value = '';
  document.getElementById('imovelTipo').value = 'Casa';
  document.getElementById('imovelValor').value = '';
  new bootstrap.Modal(document.getElementById('modalImovel')).show();
}

async function salvarImovel() {
  const data = {
    endereco: document.getElementById('imovelEndereco').value.trim(),
    tipo: document.getElementById('imovelTipo').value,
    valor: Number(document.getElementById('imovelValor').value) || 0
  };

  if (!data.endereco || data.valor <= 0) return alert('Preencha todos os campos corretamente');

  try {
    await pb.collection('imoveis').create(data);
    bootstrap.Modal.getInstance(document.getElementById('modalImovel')).hide();
    await loadAllData();
    alert('Imóvel cadastrado com sucesso!');
  } catch (err) {
    alert('Erro ao cadastrar imóvel: ' + err.message);
  }
}

function abrirModalInquilino() {
  document.getElementById('inquilinoNome').value = '';
  document.getElementById('inquilinoNasc').value = '';
  document.getElementById('inquilinoCpf').value = '';
  document.getElementById('inquilinoRg').value = '';
  document.getElementById('inquilinoCivil').value = 'Solteiro(a)';
  document.getElementById('inquilinoProfissao').value = '';
  document.getElementById('inquilinoNac').value = 'Brasileira';
  new bootstrap.Modal(document.getElementById('modalInquilino')).show();
}

async function salvarInquilino() {
  const data = {
    nome: document.getElementById('inquilinoNome').value.trim(),
    nasc: document.getElementById('inquilinoNasc').value || null,
    cpf: document.getElementById('inquilinoCpf').value.trim(),
    rg: document.getElementById('inquilinoRg').value.trim() || null,
    civil: document.getElementById('inquilinoCivil').value,
    profissao: document.getElementById('inquilinoProfissao').value.trim() || null,
    nacionalidade: document.getElementById('inquilinoNac').value.trim() || null
  };

  if (!data.nome || !data.cpf || !data.nasc) return alert('Preencha nome, CPF e data de nascimento');

  try {
    await pb.collection('inquilinos').create(data);
    bootstrap.Modal.getInstance(document.getElementById('modalInquilino')).hide();
    await loadAllData();
    alert('Inquilino cadastrado com sucesso!');
  } catch (err) {
    alert('Erro ao cadastrar inquilino: ' + err.message);
  }
}

function abrirModalContrato() {
  const selImovel = document.getElementById('contratoImovel');
  selImovel.innerHTML = '<option value="">Selecione o imóvel...</option>';
  imoveis.forEach(im => {
    selImovel.innerHTML += `<option value="${im.id}">${im.endereco} (${im.tipo})</option>`;
  });

  const selInq = document.getElementById('contratoInquilino');
  selInq.innerHTML = '<option value="">Selecione o inquilino...</option>';
  inquilinos.forEach(iq => {
    selInq.innerHTML += `<option value="${iq.id}">${iq.nome} - ${iq.cpf}</option>`;
  });

  new bootstrap.Modal(document.getElementById('modalContrato')).show();
}

async function salvarContrato() {
  const imovelId = document.getElementById('contratoImovel').value;
  const inquilinoId = document.getElementById('contratoInquilino').value;
  const dataInicio = document.getElementById('contratoInicio').value;
  const dataFim = document.getElementById('contratoFim').value;

  if (!imovelId || !inquilinoId || !dataInicio || !dataFim) return alert('Preencha todos os campos');

  try {
    await pb.collection('contratos').create({
      imovelId,
      inquilinoId,
      ativo: true
    });

    await pb.collection('imoveis').update(imovelId, {
      inquilinoId,
      dataInicio,
      dataFim
    });

    bootstrap.Modal.getInstance(document.getElementById('modalContrato')).hide();
    await loadAllData();
    alert('Contrato cadastrado e imóvel atualizado!');
  } catch (err) {
    alert('Erro ao cadastrar contrato: ' + err.message);
  }
}

async function encerrarContrato(contratoId, imovelId) {
  if (!confirm('Tem certeza que deseja encerrar este contrato? O imóvel será liberado.')) return;

  try {
    await pb.collection('contratos').update(contratoId, {
      ativo: false
    });

    await pb.collection('imoveis').update(imovelId, {
      inquilinoId: null,
      dataInicio: null,
      dataFim: null
    });

    await loadAllData();
    alert('Contrato encerrado com sucesso! Imóvel liberado.');
  } catch (err) {
    alert('Erro ao encerrar contrato: ' + err.message);
  }
}

function abrirModalPagamento(pagId = null) {
  const sel = document.getElementById('pagImovel');
  sel.innerHTML = '<option value="">Selecione o imóvel...</option>';
  imoveis.forEach(im => {
    sel.innerHTML += `<option value="${im.id}">${im.endereco} (R$ ${Number(im.valor || 0).toLocaleString('pt-BR')})</option>`;
  });

  document.getElementById('pagId').value = pagId || '';
  document.getElementById('modalPagamentoTitle').textContent = pagId ? 'Editar Pagamento' : 'Registrar Pagamento';

  if (pagId) {
    const pag = pagamentos.find(p => p.id === pagId);
    if (pag) {
      document.getElementById('pagImovel').value = pag.imovelId || '';
      document.getElementById('pagMesAno').value = pag.mesAno || '';
      document.getElementById('pagValor').value = pag.valorPago || '';
      document.getElementById('pagData').value = pag.dataPgto || '';
      document.getElementById('pagObs').value = pag.obs || '';
    }
  } else {
    document.getElementById('pagMesAno').value = new Date().toISOString().slice(0, 7);
    document.getElementById('pagValor').value = '';
    document.getElementById('pagData').value = '';
    document.getElementById('pagObs').value = '';
  }

  new bootstrap.Modal(document.getElementById('modalPagamento')).show();
}

async function salvarPagamento() {
  const pagId = document.getElementById('pagId').value;
  const imovelId = document.getElementById('pagImovel').value;
  const mesAno = document.getElementById('pagMesAno').value;
  const valorPago = Number(document.getElementById('pagValor').value) || 0;
  const dataPgto = document.getElementById('pagData').value;
  const obs = document.getElementById('pagObs').value.trim();

  if (!imovelId || !mesAno || valorPago <= 0) return alert('Preencha imóvel, mês/ano e valor pago');

  const data = {
    imovelId,
    mesAno,
    valorPago,
    dataPgto: dataPgto || null,
    obs: obs || null
  };

  try {
    if (pagId) {
      await pb.collection('pagamentos').update(pagId, data);
      alert('Pagamento atualizado com sucesso!');
    } else {
      await pb.collection('pagamentos').create(data);
      alert('Pagamento registrado com sucesso!');
    }

    bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
    await loadAllData();
  } catch (err) {
    alert('Erro ao salvar pagamento: ' + err.message);
  }
}

function editarPagamento(id) {
  abrirModalPagamento(id);
}
</script>
</body>
</html>
